<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokémon Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            color: #ecf0f1;
        }

        .game-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 10px;
        }

        .game-header {
            text-align: center;
            width: 100%;
            padding: 10px;
            background: #34495e;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .game-title {
            font-size: 24px;
            margin-bottom: 5px;
            color: #f1c40f;
            text-shadow: 2px 2px 0 #7d6608;
        }

        .game-stats {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            margin-top: 5px;
        }

        .game-area {
            position: relative;
            width: 600px;
            height: 400px;
            background: #27ae60;
            border: 4px solid #2c3e50;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* ===== JOYSTICK SYSTEM ===== */
        .joystick-container {
            position: absolute;
            bottom: 15px;
            left: 15px;
            z-index: 10;
            width: 120px;
            height: 120px;
            pointer-events: none;
        }

        .joystick-base {
            position: absolute;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #666;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .joystick-handle {
            position: absolute;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #3498db, #2980b9);
            border: 3px solid #000;
            border-radius: 50%;
            top: 30px;
            left: 30px;
            cursor: pointer;
            touch-action: none;
            box-shadow: 0 4px 0 #1c5a87;
            transition: transform 0.1s;
            pointer-events: all;
            z-index: 11;
        }

        .joystick-handle:active {
            box-shadow: 0 2px 0 #1c5a87;
        }

        .catch-button-container {
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 10;
            pointer-events: none;
        }

        .catch-button-joystick {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            border: 4px solid #000;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 6px 0 #96281b;
            transition: all 0.1s;
            user-select: none;
            pointer-events: all;
            text-align: center;
            padding: 5px;
        }

        .catch-button-joystick:active {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #96281b;
        }

        /* REMOVED ORIGINAL CONTROLS - ONLY JOYSTICK */
        .controls {
            display: none !important;
        }

        .message-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #f1c40f;
            border-radius: 10px;
            text-align: center;
            font-size: 16px;
            line-height: 1.4;
            z-index: 10;
            display: none;
        }

        .message-box.scrollable {
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
        }

        .message-box button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #3498db;
            border: none;
            border-radius: 5px;
            color: white;
            font-family: 'Courier New', monospace;
            cursor: pointer;
        }

        .message-box .love-button {
            background: #e74c3c;
            font-weight: bold;
            font-size: 18px;
            padding: 12px 24px;
            margin-top: 20px;
        }

        .pokemon-caught {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }

        .pokeball {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid black;
            position: relative;
        }

        .pokeball:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: black;
            transform: translateY(-1px);
        }

        .pokeball:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: white;
            border: 2px solid black;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .pokeball.caught {
            background: #e74c3c;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            z-index: 5;
        }

        /* Updated popup styles */
        .final-message-popup {
            position: absolute;
            top: 25%; /* Positioned above cake */
            left: 50%;
            transform: translate(-50%, 0);
            background: rgba(0, 0, 0, 0.95);
            border: 4px solid #e74c3c; /* Red border for love messages */
            border-radius: 15px;
            padding: 25px 35px;
            color: white;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            z-index: 45; /* HIGHEST - Above everything */
            display: none;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
            min-width: 300px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
            50% { box-shadow: 0 0 40px rgba(231, 76, 60, 0.8); }
            100% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
        }

        .cake-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 40; /* Below popups, above canvas */
            background: rgba(0, 0, 0, 0.9); /* Dark background */
        }

        .cake-image {
            max-width: 85%;
            max-height: 75%;
            object-fit: contain;
            z-index: 40; /* Same as container */
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-15px) scale(1.02); }
        }

        @media (max-width: 600px) {
            .game-area {
                width: 100%;
                height: 60vh;
            }

            .final-message-popup {
                font-size: 24px;
                padding: 20px 25px;
                min-width: 250px;
                top: 20%; /* Slightly higher on mobile */
            }

            .cake-image {
                max-width: 95%;
                max-height: 65%;
            }

            /* Adjust joystick for mobile */
            .joystick-container {
                bottom: 10px;
                left: 10px;
                width: 100px;
                height: 100px;
            }

            .joystick-base {
                width: 100px;
                height: 100px;
            }

            .joystick-handle {
                width: 50px;
                height: 50px;
                top: 25px;
                left: 25px;
            }

            .catch-button-container {
                bottom: 10px;
                right: 10px;
            }

            .catch-button-joystick {
                width: 70px;
                height: 70px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">POKÉMON ADVENTURE 1</h1>
            <div class="game-stats">
                <div>Pokémon Caught: <span id="caughtCount">0</span>/5</div>
                <div>Steps: <span id="stepCount">0</span></div>
            </div>
        </div>
        
        <div class="game-area">
            <!-- Joystick System -->
            <div class="joystick-container">
                <div class="joystick-base"></div>
                <div class="joystick-handle" id="joystickHandle"></div>
            </div>

            <!-- Catch Button -->
            <div class="catch-button-container">
                <div class="catch-button-joystick" id="catchButtonJoystick">CATCH</div>
            </div>

            <div class="loading" id="loading">Loading Pokémon Adventure...</div>
            <canvas id="gameCanvas" width="600" height="400"></canvas>
            
            <div class="pokemon-caught">
                <div class="pokeball"></div>
                <div class="pokeball"></div>
                <div class="pokeball"></div>
                <div class="pokeball"></div>
                <div class="pokeball"></div>
            </div>
            
            <div class="message-box" id="messageBox">
                <p id="messageText"></p>
                <button id="closeMessage">OK</button>
            </div>

            <div class="cake-container" id="cakeContainer">
                <img id="cakeImage" class="cake-image" alt="Cake" crossorigin="anonymous">
            </div>
            
            <div class="final-message-popup" id="finalMessagePopup"></div>
        </div>
        
        <!-- REMOVED CONTROLS DIV - KEEPING ONLY RESET BUTTON -->
        <button id="resetBtn" style="
            padding: 12px 24px;
            background: #9b59b6;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            color: white;
            box-shadow: 0 4px 0 #8e44ad;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin-top: 10px;
        ">RESET</button>
    </div>

    <script>
        // Game elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessage = document.getElementById('closeMessage');
        const caughtCount = document.getElementById('caughtCount');
        const stepCount = document.getElementById('stepCount');
        const pokeballs = document.querySelectorAll('.pokeball');
        const loading = document.getElementById('loading');
        const cakeContainer = document.getElementById('cakeContainer');
        const cakeImage = document.getElementById('cakeImage');
        const finalMessagePopup = document.getElementById('finalMessagePopup');
        const resetBtn = document.getElementById('resetBtn');
        
        // Joystick elements
        const joystickHandle = document.getElementById('joystickHandle');
        const catchButtonJoystick = document.getElementById('catchButtonJoystick');
        
        // Game images
        const images = {
            map: new Image(),
            player: new Image(),
            pokemons: [
                new Image(), new Image(), new Image(), new Image(), new Image()
            ],
            heart: new Image(),
            cake: new Image()
        };

        // Audio
        const audio = new Audio('audio/celebration.mp3');
        audio.loop = true;

        // Store processed images
        const processedImages = {
            player: null,
            pokemons: [null, null, null, null, null],
            heart: null,
            cake: null
        };

        // Large sizes for maximum visibility
        const CHARACTER_SIZE = 70;
        const POKEMON_SIZE = 70;
        const HEART_SIZE = 80;
        const PLAYER_SPEED = 5;
        
        // Game state
        const gameState = {
            player: {
                x: 300,
                y: 200,
                width: CHARACTER_SIZE,
                height: CHARACTER_SIZE,
                speed: PLAYER_SPEED,
                direction: 'down'
            },
            pokemons: [],
            heart: null,
            caughtPokemons: 0,
            steps: 0,
            allPokemonCaught: false,
            heartSpawned: false,
            messages: [
                "ON THIS SPECIAL DAY OF YOURS, I WISH A REALLY REALLY REALLY HAPPY BIRTHDAY AND I HOPE YOU HAVE SUCH A BLAST TODAY AND YOU ENJOY EVERY MOMENT NOT JUST TODAY BUT FOREVER",
                "I LOVE YOU TODAY TOMORROW AND FOREVER, NOT SAYING THIS OUT OF HABIT BUT SAYING THIS TO REMIND YOU THAT YOU HAVE YOUR BIGGEST FAN IN THE DAYS OF WORSE OR THE BEST CHEERING FOR YOU AT THE BACK STAGE. THE ONE WHO LOVES ALL YOUR ACHIEVEMENTS AND THE ONE WHO WOULD FIGHT THE WORLD WITHOUT A SECOND THOUGHT!!!",
                "YOU MAKE ME HAPPY AMORRRRRR BUT YOU HAPPY MAKES ME THE HAPPIEST, SO I HOPE THIS MINI GAME BRINGS YOU A GIGGLE OR AT LEAST A SMILE! TE QUIEROOOOOOOOOOOOOOOOO",
                "I LOVE YOU SO SO SO SO SO SO SO SO SO SO SO SO SO SO SO SO SO SO SO SO SO SO MUCHHHHH THAT I LOVE YOU THE MOST AND MORE.. YEIKS I WIN THAT BET BABBYYYYYYYY!! NOT GONNA LET YOU WIN THIS ONE, EVER. OLEEEEEEEE AND A HAPPY BIRTHDAYYYYYYYY",
                "I WANNA TELL YOU HOW MUCH YOU MEAN TO ME. YOUR SMILE THAT FADES THE BAD DAYS IN MY LIFE, YOUR GIGGLE THAT GETS ME OUT OF ANY PAIN, YOUR EYES THAT MAKE ME APPRECIATE HAVING EYES (I KNOW ITS A GOOD ONE, DONT BE SHY JUST APPRECIATE IT. DO IT) I LOVE EVERYTHING IN YOU AS IF IT WAS TRULY MADE FOR ME. AND I LOVE YOU THE MOST. I KEEP FALLING HARDER AND HARDER FOR YOU EVERYDAY AND I LOVE THIS FEELING OF FALLING AND I WISH TO KEEP FALLING FOREVER, TE QUIERO MI VIDA <3!!"
            ],
            pokemonNames: ["Pikachu", "Charmander", "Squirtle", "Bulbasaur", "Jigglypuff"],
            finalMessage: "since you have read all my messages, you deserve a final one more.. its to show you that you are not just seen but hear, not just heard but valued, not just valued but loved, not just loved but desired, not just desired but adored, not just adored but invested on, not just invested on but taken care of, not just taken care of but talked about , not just talked about but preferred, not just preferred but chosen, not just chosen but prayed for and finally not just prayed for but seen. in this truly eternity loop you will always find yourself and me, repeating it over and over again.",
            loveMessages: [
                "I LOVE YOU",
                "te amo", 
                "मुझे तुमसे प्यार है",
                "t'estime",
                "Je vous aime",
                "eu te amo",
                "Ich liebe dich",
                "ti amo",
                "愛してます",
                "أحبك"
            ],
            celebrationActive: false
        };

        // ===== JOYSTICK SYSTEM =====
        function setupJoystick() {
            const joystickBase = document.querySelector('.joystick-base');
            
            if (!joystickHandle) {
                console.error("Joystick handle not found!");
                return;
            }
            
            let isDragging = false;
            let startX, startY;
            let baseRect;
            let lastMoveTime = 0;
            const moveDelay = 50; // milliseconds between moves
            const threshold = 35; // Sensitivity threshold - HIGHER = LESS SENSITIVE
            
            // Touch/Click start
            const startDrag = (clientX, clientY) => {
                isDragging = true;
                baseRect = joystickBase.getBoundingClientRect();
                startX = baseRect.left + baseRect.width / 2;
                startY = baseRect.top + baseRect.height / 2;
                updateJoystick(clientX, clientY);
            };
            
            // Update joystick position and movement
            const updateJoystick = (clientX, clientY) => {
                if (!isDragging) return;
                
                const deltaX = clientX - startX;
                const deltaY = clientY - startY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const maxDistance = 30;
                
                // Limit joystick movement
                const angle = Math.atan2(deltaY, deltaX);
                const limitedDistance = Math.min(distance, maxDistance);
                
                const joyX = Math.cos(angle) * limitedDistance;
                const joyY = Math.sin(angle) * limitedDistance;
                
                joystickHandle.style.transform = `translate(${joyX}px, ${joyY}px)`;
                
                let direction = null;
                
                // Only move if joystick is pushed significantly (threshold = 35)
                if (Math.abs(joyX) > threshold || Math.abs(joyY) > threshold) {
                    // Check which axis has stronger movement
                    if (Math.abs(joyX) > Math.abs(joyY)) {
                        direction = joyX > 0 ? 'right' : 'left';
                    } else {
                        direction = joyY > 0 ? 'down' : 'up';
                    }
                    
                    // Throttle movement to prevent too fast movement
                    const now = Date.now();
                    if (now - lastMoveTime > moveDelay) {
                        movePlayer(direction);
                        lastMoveTime = now;
                    }
                }
            };
            
            // Stop dragging
            const stopDrag = () => {
                if (isDragging) {
                    isDragging = false;
                    joystickHandle.style.transform = 'translate(0, 0)';
                    lastMoveTime = 0;
                }
            };
            
            // Touch events
            joystickHandle.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrag(e.touches[0].clientX, e.touches[0].clientY);
            });
            
            joystickHandle.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
                }
            }, { passive: false });
            
            document.addEventListener('touchend', stopDrag);
            document.addEventListener('touchcancel', stopDrag);
            
            // Mouse events for testing
            joystickHandle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startDrag(e.clientX, e.clientY);
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    updateJoystick(e.clientX, e.clientY);
                }
            });
            
            document.addEventListener('mouseup', stopDrag);
            
            console.log("Joystick setup complete!");
        }

        // Setup joystick catch button
        function setupJoystickCatchButton() {
            if (!catchButtonJoystick) {
                console.error("Catch button not found!");
                return;
            }
            
            catchButtonJoystick.addEventListener('click', () => {
                catchPokemon();
            });
            
            catchButtonJoystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                catchPokemon();
            });
            
            console.log("Catch button setup complete!");
        }

        // Simplified image processing - just load without processing
        function loadImages() {
            let loadedCount = 0;
            const totalImages = 9; // Map, player, 5 pokemon, heart, cake
            
            function imageLoaded() {
                loadedCount++;
                console.log(`Loaded ${loadedCount}/${totalImages} images`);
                
                if (loadedCount === totalImages) {
                    setTimeout(() => {
                        loading.style.display = 'none';
                        initGame();
                    }, 500);
                }
            }
            
            // Set fallback images if loading fails
            function imageError(img, name) {
                console.error(`Failed to load ${name} image`);
                img.onload = imageLoaded;
                img.src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%23ccc"/><text x="50" y="50" font-size="12" text-anchor="middle" fill="%23000">${name}</text></svg>`;
            }
            
            // Load map image
            images.map.onload = imageLoaded;
            images.map.onerror = () => imageError(images.map, 'map');
            images.map.src = 'images/map.png';
            
            // Load player image
            images.player.onload = imageLoaded;
            images.player.onerror = () => imageError(images.player, 'player');
            images.player.src = 'images/player.png';
            
            // Load pokemon images
            for (let i = 0; i < 5; i++) {
                images.pokemons[i].onload = imageLoaded;
                images.pokemons[i].onerror = () => imageError(images.pokemons[i], `pokemon${i+1}`);
                images.pokemons[i].src = `images/pokemon${i+1}.png`;
            }

            // Load heart image
            images.heart.onload = imageLoaded;
            images.heart.onerror = () => imageError(images.heart, 'heart');
            images.heart.src = 'images/heart.png';

            // Load cake image
            images.cake.onload = imageLoaded;
            images.cake.onerror = () => imageError(images.cake, 'cake');
            images.cake.src = 'images/cake.png';
        }
        
        // Initialize game
        function initGame() {
            console.log("Initializing game...");
            
            // Reset game state
            gameState.player.x = 300 - CHARACTER_SIZE / 2;
            gameState.player.y = 200 - CHARACTER_SIZE / 2;
            gameState.caughtPokemons = 0;
            gameState.steps = 0;
            gameState.pokemons = [];
            gameState.heart = null;
            gameState.allPokemonCaught = false;
            gameState.heartSpawned = false;
            gameState.celebrationActive = false;
            
            // Stop audio if playing
            audio.pause();
            audio.currentTime = 0;
            
            // Hide cake container and popup
            cakeContainer.style.display = 'none';
            finalMessagePopup.style.display = 'none';
            
            // Show canvas
            canvas.style.display = 'block';
            
            // Update UI
            caughtCount.textContent = gameState.caughtPokemons;
            stepCount.textContent = gameState.steps;
            
            // Reset pokeballs
            pokeballs.forEach(ball => ball.classList.remove('caught'));
            
            // Create pokemons
            for (let i = 0; i < 5; i++) {
                let overlap;
                let x, y;
                do {
                    overlap = false;
                    x = Math.random() * (canvas.width - POKEMON_SIZE);
                    y = Math.random() * (canvas.height - POKEMON_SIZE);
                    
                    // Check for overlap with existing pokemons
                    for (let pokemon of gameState.pokemons) {
                        if (Math.abs(x - pokemon.x) < POKEMON_SIZE * 1.5 && 
                            Math.abs(y - pokemon.y) < POKEMON_SIZE * 1.5) {
                            overlap = true;
                            break;
                        }
                    }
                } while (overlap);
                
                gameState.pokemons.push({
                    id: i,
                    x: x,
                    y: y,
                    width: POKEMON_SIZE,
                    height: POKEMON_SIZE,
                    caught: false
                });
            }
            
            // Setup joystick
            setupJoystick();
            setupJoystickCatchButton();
            
            drawGame();
            console.log("Game initialized successfully!");
        }
        
        // Draw game
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw map
            if (images.map.complete) {
                ctx.drawImage(images.map, 0, 0, canvas.width, canvas.height);
            } else {
                // Fallback background
                ctx.fillStyle = '#27ae60';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Draw pokemons
            gameState.pokemons.forEach(pokemon => {
                if (!pokemon.caught && images.pokemons[pokemon.id].complete) {
                    ctx.drawImage(
                        images.pokemons[pokemon.id], 
                        Math.round(pokemon.x), 
                        Math.round(pokemon.y),
                        pokemon.width,
                        pokemon.height
                    );
                }
            });
            
            // Draw heart if spawned
            if (gameState.heart && images.heart.complete) {
                ctx.drawImage(
                    images.heart,
                    Math.round(gameState.heart.x),
                    Math.round(gameState.heart.y),
                    gameState.heart.width,
                    gameState.heart.height
                );
            }
            
            // Draw player
            if (images.player.complete) {
                ctx.drawImage(
                    images.player, 
                    Math.round(gameState.player.x), 
                    Math.round(gameState.player.y),
                    gameState.player.width,
                    gameState.player.height
                );
            }
        }
        
        // Move player
        function movePlayer(direction) {
            const p = gameState.player;
            p.direction = direction;
            
            let newX = p.x;
            let newY = p.y;
            
            if (direction === 'up') newY -= p.speed;
            if (direction === 'down') newY += p.speed;
            if (direction === 'left') newX -= p.speed;
            if (direction === 'right') newX += p.speed;
            
            // Boundary checking
            if (newX >= 0 && newX <= canvas.width - p.width) {
                p.x = newX;
            }
            if (newY >= 0 && newY <= canvas.height - p.height) {
                p.y = newY;
            }
            
            gameState.steps++;
            stepCount.textContent = gameState.steps;
            
            drawGame();
        }
        
        // Check for pokemon collision
        function checkPokemonCollision() {
            const p = gameState.player;
            
            for (let pokemon of gameState.pokemons) {
                if (pokemon.caught) continue;
                
                if (p.x < pokemon.x + pokemon.width &&
                    p.x + p.width > pokemon.x &&
                    p.y < pokemon.y + pokemon.height &&
                    p.y + p.height > pokemon.y) {
                    return pokemon;
                }
            }
            
            return null;
        }

        // Check for heart collision
        function checkHeartCollision() {
            const p = gameState.player;
            const heart = gameState.heart;
            
            if (!heart) return false;
            
            return (p.x < heart.x + heart.width &&
                    p.x + p.width > heart.x &&
                    p.y < heart.y + heart.height &&
                    p.y + p.height > heart.y);
        }
        
        // Catch pokemon
        function catchPokemon() {
            const pokemon = checkPokemonCollision();
            
            if (pokemon) {
                pokemon.caught = true;
                gameState.caughtPokemons++;
                
                caughtCount.textContent = gameState.caughtPokemons;
                pokeballs[pokemon.id].classList.add('caught');
                
                showMessage(gameState.messages[pokemon.id]);
                drawGame();
                
                if (gameState.caughtPokemons === 5 && !gameState.heartSpawned) {
                    spawnHeart();
                }
            } else {
                showMessage("No Pokémon nearby to catch! Get closer to a Pokémon first.");
            }
        }

        // Spawn heart in the middle of the map
        function spawnHeart() {
            gameState.allPokemonCaught = true;
            gameState.heartSpawned = true;
            
            // Place heart in the center
            gameState.heart = {
                x: canvas.width / 2 - HEART_SIZE / 2,
                y: canvas.height / 2 - HEART_SIZE / 2,
                width: HEART_SIZE,
                height: HEART_SIZE
            };
            
            showMessage("A special heart has appeared in the center of the map! Go to the heart and click 'OPEN'!");
            drawGame();
        }

        // Open heart
        function openHeart() {
            if (gameState.heart && checkHeartCollision()) {
                showFinalMessage();
            }
        }

        // Show final scrollable message
        function showFinalMessage() {
            messageBox.classList.add('scrollable');
            messageText.innerHTML = `
                <p style="margin-bottom: 15px; text-align: center; font-weight: bold;">Your Special Message:</p>
                <p style="margin-bottom: 20px;">${gameState.finalMessage}</p>
            `;
            
            // Create love button
            const loveButton = document.createElement('button');
            loveButton.textContent = 'I LOVE YOU';
            loveButton.className = 'love-button';
            loveButton.onclick = startCakeCelebration;
            
            // Clear existing buttons and add new one
            const existingButton = messageBox.querySelector('#closeMessage');
            if (existingButton) {
                messageBox.removeChild(existingButton);
            }
            messageBox.appendChild(loveButton);
            
            messageBox.style.display = 'block';
        }

        // Start cake celebration
        function startCakeCelebration() {
            messageBox.style.display = 'none';
            gameState.celebrationActive = true;
            
            // Hide canvas and show cake container
            canvas.style.display = 'none';
            cakeContainer.style.display = 'flex';
            
            // Set cake image
            cakeImage.src = images.cake.src;
            
            // Configure and play audio
            audio.loop = true;
            audio.play().catch(e => console.log('Audio play failed:', e));
            
            // Start showing love messages above the cake
            setTimeout(() => {
                showLoveMessages(0);
            }, 1000);
        }

        // Show love messages in sequence
        function showLoveMessages(index) {
            if (index < gameState.loveMessages.length) {
                finalMessagePopup.textContent = gameState.loveMessages[index];
                finalMessagePopup.style.display = 'block';
                
                // Add fade-in effect
                finalMessagePopup.style.opacity = '0';
                finalMessagePopup.style.transform = 'translate(-50%, 0) scale(0.8)';
                
                setTimeout(() => {
                    finalMessagePopup.style.transition = 'all 0.3s ease';
                    finalMessagePopup.style.opacity = '1';
                    finalMessagePopup.style.transform = 'translate(-50%, 0) scale(1)';
                }, 10);
                
                setTimeout(() => {
                    // Fade out
                    finalMessagePopup.style.opacity = '0';
                    finalMessagePopup.style.transform = 'translate(-50%, 0) scale(0.8)';
                    
                    setTimeout(() => {
                        finalMessagePopup.style.display = 'none';
                        setTimeout(() => {
                            showLoveMessages(index + 1);
                        }, 300);
                    }, 300);
                }, 1500);
            } else {
                // All messages shown, wait 3 seconds with audio still playing
                setTimeout(() => {
                    finalMessagePopup.textContent = "FOREVER AND ALWAYS";
                    finalMessagePopup.style.display = 'block';
                    finalMessagePopup.style.opacity = '1';
                    finalMessagePopup.style.transform = 'translate(-50%, 0) scale(1)';
                    
                    // Stop audio after 3 more seconds
                    setTimeout(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        gameState.celebrationActive = false;
                    }, 3000);
                }, 500);
            }
        }
        
        // Show message
        function showMessage(message) {
            messageBox.classList.remove('scrollable');
            messageText.textContent = message;
            
            // Reset to default OK button
            const loveButton = messageBox.querySelector('.love-button');
            if (loveButton) {
                messageBox.removeChild(loveButton);
            }
            
            const existingButton = messageBox.querySelector('#closeMessage');
            if (!existingButton) {
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'OK';
                closeBtn.id = 'closeMessage';
                closeBtn.onclick = () => messageBox.style.display = 'none';
                messageBox.appendChild(closeBtn);
            }
            
            messageBox.style.display = 'block';
        }
        
        // Close message
        closeMessage.addEventListener('click', () => {
            messageBox.style.display = 'none';
        });
        
        // Keyboard controls (for testing)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp') movePlayer('up');
            if (e.key === 'ArrowDown') movePlayer('down');
            if (e.key === 'ArrowLeft') movePlayer('left');
            if (e.key === 'ArrowRight') movePlayer('right');
            if (e.key === ' ' || e.key === 'Enter') {
                catchPokemon();
            }
        });
        
        // Reset button
        resetBtn.addEventListener('click', initGame);
        
        // Start the game
        console.log("Starting game load...");
        loadImages();
    </script>
</body>
</html>