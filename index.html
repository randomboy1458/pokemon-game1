<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pokémon Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            color: #ecf0f1;
        }

        .game-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 10px;
        }

        .game-header {
            text-align: center;
            width: 100%;
            padding: 10px;
            background: #34495e;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .game-title {
            font-size: 24px;
            margin-bottom: 5px;
            color: #f1c40f;
            text-shadow: 2px 2px 0 #7d6608;
        }

        .game-stats {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
            margin-top: 5px;
        }

        .game-area {
            position: relative;
            width: 600px;
            height: 400px;
            background: #27ae60;
            border: 4px solid #2c3e50;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .d-pad {
            display: grid;
            grid-template-areas:
                ". up ."
                "left . right"
                ". down .";
            gap: 5px;
            margin-bottom: 10px;
        }

        .d-pad button {
            width: 60px;
            height: 60px;
            background: #3498db;
            border: none;
            border-radius: 8px;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 0 #2980b9;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
        }

        .d-pad button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #2980b9;
        }

        .d-pad button:nth-child(1) { grid-area: up; }
        .d-pad button:nth-child(2) { grid-area: left; }
        .d-pad button:nth-child(3) { grid-area: right; }
        .d-pad button:nth-child(4) { grid-area: down; }

        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .action-buttons button {
            padding: 12px 24px;
            background: #e74c3c;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            color: white;
            box-shadow: 0 4px 0 #c0392b;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .action-buttons button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #c0392b;
        }

        .action-buttons button:nth-child(2) {
            background: #9b59b6;
            box-shadow: 0 4px 0 #8e44ad;
        }

        .action-buttons button:nth-child(2):active {
            box-shadow: 0 0 0 #8e44ad;
        }

        .message-box {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #f1c40f;
            border-radius: 10px;
            text-align: center;
            font-size: 16px;
            line-height: 1.4;
            z-index: 10;
            display: none;
        }

        .message-box button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #3498db;
            border: none;
            border-radius: 5px;
            color: white;
            font-family: 'Courier New', monospace;
            cursor: pointer;
        }

        .pokemon-caught {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }

        .pokeball {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid black;
            position: relative;
        }

        .pokeball:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: black;
            transform: translateY(-1px);
        }

        .pokeball:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: white;
            border: 2px solid black;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .pokeball.caught {
            background: #e74c3c;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            z-index: 5;
        }

        @media (max-width: 600px) {
            .game-area {
                width: 100%;
                height: 60vh;
            }
            
            .d-pad button {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">POKÉMON ADVENTURE 1</h1>
            <div class="game-stats">
                <div>Pokémon Caught: <span id="caughtCount">0</span>/5</div>
                <div>Steps: <span id="stepCount">0</span></div>
            </div>
        </div>
        
        <div class="game-area">
            <div class="loading" id="loading">Loading Pokémon Adventure...</div>
            <canvas id="gameCanvas" width="600" height="400"></canvas>
            
            <div class="pokemon-caught">
                <div class="pokeball"></div>
                <div class="pokeball"></div>
                <div class="pokeball"></div>
                <div class="pokeball"></div>
                <div class="pokeball"></div>
            </div>
            
            <div class="message-box" id="messageBox">
                <p id="messageText"></p>
                <button id="closeMessage">OK</button>
            </div>
        </div>
        
        <div class="controls">
            <div class="d-pad">
                <button id="upBtn">↑</button>
                <button id="leftBtn">←</button>
                <button id="rightBtn">→</button>
                <button id="downBtn">↓</button>
            </div>
            
            <div class="action-buttons">
                <button id="catchBtn">CATCH</button>
                <button id="resetBtn">RESET</button>
            </div>
        </div>
    </div>

    <script>
        // Game elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessage = document.getElementById('closeMessage');
        const caughtCount = document.getElementById('caughtCount');
        const stepCount = document.getElementById('stepCount');
        const pokeballs = document.querySelectorAll('.pokeball');
        const loading = document.getElementById('loading');
        
        // Control buttons
        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const catchBtn = document.getElementById('catchBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        // Game images
        const images = {
            map: new Image(),
            player: new Image(),
            pokemons: [
                new Image(), new Image(), new Image(), new Image(), new Image()
            ]
        };

        // Store processed images
        const processedImages = {
            player: null,
            pokemons: [null, null, null, null, null]
        };

        // Size limits to prevent oversized images
        const MAX_PLAYER_SIZE = 40;
        const MAX_POKEMON_SIZE = 35;
        
        // Game state
        const gameState = {
            player: {
                x: 300,
                y: 200,
                width: MAX_PLAYER_SIZE,
                height: MAX_PLAYER_SIZE,
                speed: 3,
                direction: 'down'
            },
            pokemons: [],
            caughtPokemons: 0,
            steps: 0,
            messages: [
                "You caught Pikachu! It's super cute and ready to join your team!",
                "Charmander is now yours! Its fiery tail will light your way!",
                "Squirtle joined your team! Get ready for some water adventures!",
                "Bulbasaur is caught! This grass-type Pokémon is a loyal companion!",
                "Jigglypuff is now yours! Get ready for some soothing lullabies!"
            ],
            pokemonNames: ["Pikachu", "Charmander", "Squirtle", "Bulbasaur", "Jigglypuff"]
        };

        // Remove white background with size limits
        function removeWhiteBackground(image, maxSize) {
            return new Promise((resolve) => {
                let originalWidth = image.naturalWidth;
                let originalHeight = image.naturalHeight;
                
                // Calculate scaling to fit within maxSize while maintaining aspect ratio
                let scale = 1;
                if (originalWidth > maxSize || originalHeight > maxSize) {
                    scale = maxSize / Math.max(originalWidth, originalHeight);
                }
                
                const targetWidth = Math.round(originalWidth * scale);
                const targetHeight = Math.round(originalHeight * scale);
                
                console.log(`Processing image: ${originalWidth}x${originalHeight} -> ${targetWidth}x${targetHeight}`);
                
                const canvas = document.createElement('canvas');
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = false;

                ctx.drawImage(image, 0, 0, targetWidth, targetHeight);

                const imageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
                const data = imageData.data;

                for (let i = 0; i < data.length; i += 4) {
                    const red = data[i];
                    const green = data[i + 1];
                    const blue = data[i + 2];

                    const isWhite = red > 220 && green > 220 && blue > 220;
                    const isLight = red > 180 && green > 180 && blue > 180;
                    
                    if (isWhite || isLight) {
                        data[i + 3] = 0;
                    }
                }

                ctx.putImageData(imageData, 0, 0);

                const processedImage = new Image();
                processedImage.onload = () => resolve({
                    image: processedImage,
                    width: targetWidth,
                    height: targetHeight
                });
                processedImage.src = canvas.toDataURL();
            });
        }
        
        // Load images
        function loadImages() {
            let loadedCount = 0;
            const totalImages = 7;
            
            function imageLoaded() {
                loadedCount++;
                console.log(`Loaded ${loadedCount}/${totalImages} images`);
                
                if (loadedCount === totalImages) {
                    processAllImages();
                }
            }
            
            // Load map image
            images.map.onload = imageLoaded;
            images.map.onerror = () => {
                console.error('Failed to load map image');
                imageLoaded();
            };
            images.map.src = 'images/map.png';
            
            // Load player image
            images.player.onload = imageLoaded;
            images.player.onerror = () => {
                console.error('Failed to load player image');
                imageLoaded();
            };
            images.player.src = 'images/player.png';
            
            // Load pokemon images
            for (let i = 0; i < 5; i++) {
                images.pokemons[i].onload = imageLoaded;
                images.pokemons[i].onerror = () => {
                    console.error(`Failed to load pokemon${i+1} image`);
                    imageLoaded();
                };
                images.pokemons[i].src = `images/pokemon${i+1}.png`;
            }
        }

        // Process all images
        async function processAllImages() {
            loading.textContent = "Processing images...";

            try {
                // Process player image with size limit
                const playerResult = await removeWhiteBackground(images.player, MAX_PLAYER_SIZE);
                processedImages.player = playerResult.image;
                gameState.player.width = playerResult.width;
                gameState.player.height = playerResult.height;

                // Process pokemon images with size limits
                for (let i = 0; i < 5; i++) {
                    const pokemonResult = await removeWhiteBackground(images.pokemons[i], MAX_POKEMON_SIZE);
                    processedImages.pokemons[i] = pokemonResult.image;
                }

                loading.style.display = 'none';
                initGame();
            } catch (error) {
                console.error('Error processing images:', error);
                loading.textContent = "Error loading images";
            }
        }
        
        // Initialize game
        function initGame() {
            // Reset game state
            gameState.player.x = 300 - gameState.player.width / 2;
            gameState.player.y = 200 - gameState.player.height / 2;
            gameState.caughtPokemons = 0;
            gameState.steps = 0;
            gameState.pokemons = [];
            
            // Update UI
            caughtCount.textContent = gameState.caughtPokemons;
            stepCount.textContent = gameState.steps;
            
            // Reset pokeballs
            pokeballs.forEach(ball => ball.classList.remove('caught'));
            
            // Create pokemons with fixed sizes
            for (let i = 0; i < 5; i++) {
                gameState.pokemons.push({
                    id: i,
                    x: Math.random() * (canvas.width - MAX_POKEMON_SIZE),
                    y: Math.random() * (canvas.height - MAX_POKEMON_SIZE),
                    width: MAX_POKEMON_SIZE,
                    height: MAX_POKEMON_SIZE,
                    caught: false
                });
            }
            
            drawGame();
        }
        
        // Draw game
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw map
            ctx.drawImage(images.map, 0, 0, canvas.width, canvas.height);
            
            // Draw pokemons
            gameState.pokemons.forEach(pokemon => {
                if (!pokemon.caught && processedImages.pokemons[pokemon.id]) {
                    ctx.drawImage(
                        processedImages.pokemons[pokemon.id], 
                        Math.round(pokemon.x), 
                        Math.round(pokemon.y),
                        pokemon.width,
                        pokemon.height
                    );
                }
            });
            
            // Draw player
            if (processedImages.player) {
                ctx.drawImage(
                    processedImages.player, 
                    Math.round(gameState.player.x), 
                    Math.round(gameState.player.y),
                    gameState.player.width,
                    gameState.player.height
                );
            }
        }
        
        // Move player
        function movePlayer(direction) {
            const p = gameState.player;
            p.direction = direction;
            
            let newX = p.x;
            let newY = p.y;
            
            if (direction === 'up') newY -= p.speed;
            if (direction === 'down') newY += p.speed;
            if (direction === 'left') newX -= p.speed;
            if (direction === 'right') newX += p.speed;
            
            // Boundary checking
            if (newX >= 0 && newX <= canvas.width - p.width) {
                p.x = newX;
            }
            if (newY >= 0 && newY <= canvas.height - p.height) {
                p.y = newY;
            }
            
            gameState.steps++;
            stepCount.textContent = gameState.steps;
            
            drawGame();
        }
        
        // Check for pokemon collision
        function checkPokemonCollision() {
            const p = gameState.player;
            
            for (let pokemon of gameState.pokemons) {
                if (pokemon.caught) continue;
                
                if (p.x < pokemon.x + pokemon.width &&
                    p.x + p.width > pokemon.x &&
                    p.y < pokemon.y + pokemon.height &&
                    p.y + p.height > pokemon.y) {
                    return pokemon;
                }
            }
            
            return null;
        }
        
        // Catch pokemon
        function catchPokemon() {
            const pokemon = checkPokemonCollision();
            
            if (pokemon) {
                pokemon.caught = true;
                gameState.caughtPokemons++;
                
                caughtCount.textContent = gameState.caughtPokemons;
                pokeballs[pokemon.id].classList.add('caught');
                
                showMessage(gameState.messages[pokemon.id]);
                drawGame();
                
                if (gameState.caughtPokemons === 5) {
                    setTimeout(() => {
                        showMessage("Congratulations! You've caught all the Pokémon! You are a true Pokémon Master!");
                    }, 1500);
                }
            } else {
                showMessage("No Pokémon nearby to catch! Get closer to a Pokémon first.");
            }
        }
        
        // Show message
        function showMessage(message) {
            messageText.textContent = message;
            messageBox.style.display = 'block';
        }
        
        // Close message
        closeMessage.addEventListener('click', () => {
            messageBox.style.display = 'none';
        });
        
        // Event listeners
        upBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            movePlayer('up');
        });
        
        downBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            movePlayer('down');
        });
        
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            movePlayer('left');
        });
        
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            movePlayer('right');
        });
        
        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp') movePlayer('up');
            if (e.key === 'ArrowDown') movePlayer('down');
            if (e.key === 'ArrowLeft') movePlayer('left');
            if (e.key === 'ArrowRight') movePlayer('right');
            if (e.key === ' ' || e.key === 'Enter') catchPokemon();
        });
        
        // Catch button
        catchBtn.addEventListener('click', catchPokemon);
        
        // Reset button
        resetBtn.addEventListener('click', initGame);
        
        // Start the game
        loadImages();
    </script>
</body>
</html>